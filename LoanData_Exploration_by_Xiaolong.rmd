---
title: "Loan Data from Prosper Exploration"
author: "Xiaolong Yang"
date: "February 18, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r import library}
library(ggplot2)
library(maps)
library(dplyr)
library(GGally)
library(corrplot) 
library(RColorBrewer)
library(scales)
```
## Abstract
Prosper is America's first peer-to-peer lending marketplace, 
with more than 2 million members and over $2,000,000,000 in funded loans.
```{r load data}
loan = read.csv("prosperLoanData.csv")
dim(loan)
```
The Prosper loan dataset contains 81 variables, with almost 114000 observations. However, not all of the variables are valuable to explore. To get enough information of both loans and borrowers, I would focus on variables for loans, such as loan amount, loan original date, 
estimated return of loan, current loan status, and variables for borrowers, such as borrowers Prosper rating, Prosper score, listing category,borrower APR, borrower income, borrower employment status, 
borrower occupation, borrower home owner, borrower credit history, 
borrower state, borrower total Prosper loans. The following give a glimpse.

```{r selected}
selected <- c("LoanOriginalAmount","LoanOriginationDate","EstimatedReturn",
              "LoanStatus","ProsperRating..Alpha.","ProsperScore",
              "ListingCategory..numeric.","BorrowerAPR","IncomeRange",
              "StatedMonthlyIncome","DebtToIncomeRatio","EmploymentStatus",
              "EmploymentStatusDuration","Occupation","IsBorrowerHomeowner",
              "CreditScoreRangeLower","CreditScoreRangeUpper",
              "MonthlyLoanPayment", "BorrowerState","TotalProsperLoans",
              "LenderYield")
loan2 = loan[selected]
str(loan2)
summary(loan2)
```
## Univariate Plots Section
The univariate plots would be devided into two sections: 
one for loan, another for borrowers. 

First, we plot the Loan original amount histograms for Prosper.
The loan amounts skew to left, with the median 6,500 less than the mean 8,337. 
In this case, I rescale the x axis. 

```{r LoanOriginalAmount}
ggplot()+
    geom_bar(data= loan2, aes(x= LoanOriginalAmount),
             colour="black",fill = I('#099DD9'),binwidth = 0.05)+
    scale_x_log10()+
    scale_y_sqrt()

```

The loan original amount histogram is normal distributed. 
It peaks at 15,000 where loan original amount is 1,500, 
which means 15,000 loans' amounts is $1,500. 

Next, we plot the Loan original time histograms for Prosper.
The data provided is allocate by date, to make it easier to find the trend, 
I reallocated the data by year.

```{r LoanOriginationYear}
loan2$LoanOriginationDate <- as.Date(loan2$LoanOriginationDate)
loan2$LoanOriginationyear = as.numeric(format(loan2$LoanOriginationDate,"%Y"))

date <-loan2 %>%
    mutate(year = format(loan2$LoanOriginationDate, "%Y"))%>%
    group_by(year) %>%
    summarise(count = n())

ggplot(data=date, aes(x=year, y=count,group = 1)) + 
    geom_line() + 
    geom_point(size=4, shape=20)
```

There is a sharp dip in 2009, and not recover to previous level until 2011. 
It corelate with climax and end the 2008 global financial crisis. 
Since the last data collected on March 2014, 
there is a big drop in the histgram in 2014.

Next, we look at Loan status count:

```{r Loan status}
qplot(data=loan2, x = LoanStatus, fill = I('#099DD9'))+
    coord_flip()+
    scale_y_log10()

```

Most of the data is completed, chargedoff, current or default, 
and there are seires of past due data.
Later, I would analyze the data into 4 sections to make it easier to analyze. 
Next, we look at prosper risk rating.

```{r ProsperRating}
loan2$ProsperRating..Alpha. <- factor(loan2$ProsperRating..Alpha., 
                                      c("AA", "A", "B","C","D","E","HR",""))


qplot(data=subset(loan2, ProsperRating..Alpha.!=''), 
      x = ProsperRating..Alpha., fill = I('#099DD9'))
```

We can easily find it follow the normal distribution. 
It peaks at C with over 20,000 count.

Higher rating is eqaul to higher score, we can analyze the prosper score next:

```{r ProsperScore}
qplot(data=loan2, binwidth = 0.5, x = ProsperScore, fill = I('#099DD9'))
```

It also follow the normal distribution. Compare both rating and score, 
we can estimate the prosper loan risk is normal distributed.

Another interesting question is why people loan from prosper. 
We plot the histogram of the listing category below. 
Because the data provided only the identigy number, 
I would rename the properties by Variable Definitions file

```{r ListingCategory processing}
ListingCategory <- c("Not Available", "Debt Consolidation", "Home Improvement",
                     "Business", "Personal Loan", "Student Use", "Auto", 
                     "Other", "Baby&Adoption" , "Boat","Cosmetic Procedure",
                     "Engagement Ring", "Green Loans", "Household Expenses", 
                     "Large Purchases", "Medical/Dental", "Motorcycle", "RV", 
                     "Taxes", "Vacation", "Wedding Loans")

    
loan2$ListingCategory <- ListingCategory[loan2$ListingCategory..numeric.+1]

loan2$ListingCategory <- factor(loan2$ListingCategory)

sample_loan <- subset(loan2,!is.na(ListingCategory)) %>%
    group_by(ListingCategory) %>%
    summarise(n = n()) %>%
    arrange(desc(n))
sample_loan[c(1:5),1]
```

The top 5 loan reason is Debt consolidation, not available, other and Business. 
Since we did not know what is the actual reason in the first 4, 
we will omit that and analyze other specific reasons.

```{r ListingCategory plot}
qplot(data=subset(loan2,
                  ListingCategory!="Debt Consolidation"&
                      ListingCategory!="Not Available"&
                      ListingCategory!="Other"), 
      x = ListingCategory, fill = I('#099DD9'))+
      coord_flip()+
      scale_y_log10()
```

We can find now the 5 top reasons of people's loan is 
Home Improvement, Business, Auto, Personal Loan and Household Expenses. 
Most of the count of other variable is among 100 and 1,000.

Next, we will analyze the BorrowAPR, Borrower's Annual Percentage Rate for loan.
It indicate the yield rate for borrowers, 
decided by market rate and the urgency of borrowers.

```{r BorrowerAPR}
ggplot()+
    geom_bar(data= loan2, 
             aes(x= BorrowerAPR),
             binwidth = 0.025,
             colour="black",
             fill = I('#099DD9'))+
    xlim(0.05,0.4)
```

We can easily find it is normal distributed. 
Average Borrower rate is 19.28%, which is pretty high. 
Since debt consolidation is the most, 
Prosper might combine several borrowers' debt together to avoid too high a rate.

Then we analyze income range:

```{r IncomeRange}
qplot(data=loan2, x = IncomeRange, fill = I('#099DD9'))+
    coord_flip()
```

We can easily find it is normal distributed.
We can easily find most of borrowers' income is lower than 75,000, 
and the average income is among 25,000 and 49,999.

Then we analyze debt to income ratio:

```{r Debt/Income}
qplot(data=loan2, x = DebtToIncomeRatio, binwidth=0.05, fill = I('#099DD9'))+
    xlim(0,1)
```

If we move the outliers, we can find the distribution is normal,
but skewed to the left.
Most of the ratio is lower than 0.5, and it peaks at 0.2.

Next we will see the employees status

```{r EmploymentStatus}
qplot(data=loan2, x = EmploymentStatus, fill = I('#099DD9'))+
    coord_flip()+
    scale_y_sqrt()
```

The majority of borrowers is employeed.

Then we find how long has they kept their employment status.

```{r Employment Status Duration}
qplot(data=loan2, x = EmploymentStatusDuration/12, 
      binwidth = 1, fill = I('#099DD9'))+
    xlim(0,40)
```

We can easily find the distribution is skewed to the left. 
Most of the borrowers kept the status less than 20 years. 
It also peaks near 1 year. 
It suggest people have instability employment status might borrow more debt.

Then we analyze borrowers' occupation

```{r occupation,warning=FALSE,fig.height=10 }
qplot(data=loan2, x = Occupation, fill = I('#099DD9'))+
    coord_flip()+
    scale_y_log10()
```

Even though I have scale the y axis, the density still fluctuated widely.
Despite the ambiguous "other" and "professianl",
we can find the computer programmer, engineer-mechanical and teacher is the top occupation among borrower.

Then we analyze how much were they home onwer.

```{r home onwer}
pie <- ggplot(loan2, 
              aes(x = factor(1), 
                  fill = factor(IsBorrowerHomeowner))) +
    geom_bar(width = 1)
pie + coord_polar(theta = "y")+labs(fill = "Home Owner")
```

We can easily find it is evenly distribute, we can not figure out any important information from here.


Then we analze the credit score lower range.

```{r Credit score range lower clean outliers }
qplot(data=loan2, 
      x = CreditScoreRangeLower,
      binwidth = 10, 
      xlim=c(400, 900), 
      fill = I('#099DD9'))
    
```

After clean the outliers, we can easily find majority borrowers have a lower 
credit score between 600 and 800. The average is lower than 700.

We can also analyze the upper range of credit score

```{r Credit Score Range Upper clean outliers}
qplot(data=loan2, x = CreditScoreRangeUpper,binwidth = 10,xlim=c(400, 900), 
      fill = I('#099DD9'))
```

We can find it has almost the same distribution but 20 higher than lower range. 
In the following analysis, I would use lower range to represent credit score.

Then we analyze the borrowers' state.
First, we transfer state abbreviation to the full name

```{r state abb transform}
 #'x' is the column of a data.frame that holds 2 digit state codes
stateFromLower <-function(x) {
   #read 52 state codes into local variable [includes DC (Washington D.C. and PR (Puerto Rico)]
  st.codes<-data.frame(state=as.factor(
      c("AK", "AL", "AR", "AZ", "CA", "CO", "CT", "DC", "DE", "FL", "GA",
        "HI", "IA", "ID", "IL", "IN", "KS", "KY", "LA", "MA", "MD", "ME",
        "MI", "MN", "MO", "MS",  "MT", "NC", "ND", "NE", "NH", "NJ", "NM",
        "NV", "NY", "OH", "OK", "OR", "PA", "PR", "RI", "SC", "SD", "TN",
        "TX", "UT", "VA", "VT", "WA", "WI", "WV", "WY")),
      full=as.factor(
          c("alaska","alabama","arkansas","arizona","california","colorado",
            "connecticut","district of columbia","delaware","florida","georgia",
            "hawaii","iowa","idaho","illinois","indiana","kansas","kentucky",
            "louisiana","massachusetts","maryland","maine","michigan","minnesota",
            "missouri","mississippi","montana","north carolina","north dakota",
            "nebraska","new hampshire","new jersey","new mexico","nevada",
            "new york","ohio","oklahoma","oregon","pennsylvania","puerto rico",
            "rhode island","south carolina","south dakota","tennessee","texas",
            "utah","virginia","vermont","washington","wisconsin",
            "west virginia","wyoming")))
     #create an nx1 data.frame of state codes from source column
  st.x<-data.frame(state=x)
     #match source codes with codes from 'st.codes' local variable and use to 
     #return the full state name
  refac.x<-st.codes$full[match(st.x$state,st.codes$state)]
     #return the full state names in the same order in which they appeared in the original source
  return(refac.x)
 
}
```

Then we find the top 5 borrowers' states and plot the state map:

```{r borrower state map}
sample_loan <- subset(loan2,!is.na(BorrowerState)) %>%
    group_by(BorrowerState) %>%
    summarise(n = n()) %>%
    arrange(desc(n))
sample_loan[c(1:5),1]

all_states <- map_data("state")
borrowerstate <- loan2 %>%
    group_by(BorrowerState) %>%
    summarise(n = n()) %>%
arrange(BorrowerState)


borrowerstate <- borrowerstate[borrowerstate$BorrowerState!="",]

borrowerstate$region <-stateFromLower(borrowerstate$BorrowerState)

Total <- merge(all_states, borrowerstate, by="region")

ggplot()+ 
    geom_polygon(data=Total, aes(x=long, y=lat, group = group,
                                 fill=Total$n),colour="white"
      ) + scale_fill_continuous(low = "lightblue", high = "darkblue", guide="colorbar")+ 
    theme_bw()  + 
    labs(fill = "borrowers",title = "Count of borrowers in each state",
         x="", y="")+
    scale_y_continuous(breaks=c()) + scale_x_continuous(breaks=c()) + theme(panel.border =  element_blank())
```

We can easily find most of state has less than 5,000 borrowers. 
The top 5 oorrowers' states were CA, TX, NY, FL, IL.

Next, we analyze the borrowewrs' total prospers loans 

```{r Total Prosper Loans}

qplot(data=loan2, x = TotalProsperLoans,binwidth = 0.5, fill = I('#099DD9'))+
    scale_y_log10()
```

We can find the count of borrowers decrease when number of loans increase. 
Most of the borrowers has less than 3 loans.


# Univariate Analysis

### What is the structure of your dataset?
The data contains 113,937 rows and 81 different variables. 
The type of data I analyzed is int, num and factor.

### What is/are the main feature(s) of interest in your dataset?
The loan original amount and the borrwoerAPR are the main features of my interest. 
The formor decided how much money borrowers want and capable to borrow, 
the latter decided how much interests rate did borrowers need to pay for the debt. 
The Prosper would like the most amount of loan for borrowers who can pay back, 
and borrowers want to have the least APR to rent the same amount of debt.


### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?
I thought all the variables I picked would be helpful to find 
how Prosper decided their original loan amount and 
at which APR borrowers would like to debt.


### Did you create any new variables from existing variables in the dataset?
Yes. The loan original date provided were precise to day, 
to make it easier to find the trend, I reallocated the data by year. 
The data of ListingCategory provided only the identigy number, 
I renamed then the  by Variable Definitions file. 
The employment Status Duration were allocated by month, I reallocated it by year. 
I also transferred the abbreviation of state to the full name.


### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?
The histogram of loan original year showed a big dip among 2009. 
It is reasonal since there was the gloabl financial crisis. 
Most of the factor data I have reorder their levels for pretty plot. 
Most of number data I have cleaned the outliers to show the
main part.


# Bivariate Plots Section
To get a glimpse, I would start with ggpairs to find out the relationship between the numeric parameters.

```{r bivariate compare, cache=TRUE, cache.path="cache/", fig.path="fig/",fig.height=10,fig.width=10}
set.seed(1)
loan_sample = loan2[sample(1:length(loan2$LoanOriginalAmount), 10000),
                    c("LoanOriginalAmount","EstimatedReturn","ProsperScore",
                      "BorrowerAPR","DebtToIncomeRatio",
                      "EmploymentStatusDuration","CreditScoreRangeLower",
                      "MonthlyLoanPayment","TotalProsperLoans",
                      "LoanOriginationyear")]
names(loan2$loan_sample)
res <- round(cor(loan_sample, use="complete.obs"),2)
corrplot(res, type = "upper", 
         tl.col = "black", tl.srt = 45)
ggpairs(data=loan_sample)
```

Pick those absolute correlation  higher than 0.4 to analyze. 
First we will analyze the loan original amount and monthly loan payment relationship:

```{r LoanOriginalAmount and MonthlyLoanPayment}
ggplot(data = loan2, aes(x= LoanOriginalAmount, y = MonthlyLoanPayment))+
      xlim(0,quantile(loan2$LoanOriginalAmount, 0.99))+
      ylim(0,quantile(loan2$MonthlyLoanPayment, 0.99))+
    geom_jitter(color = '#F79420',alpha =1/20)+
    geom_smooth(method = 'lm')
```

We can easily find the monthly payment would increase when the loan origianl amount increase. 

Then we will analyze the estimated return rate with borrower APR:

```{r EstimatedReturn and BorrowerAPR}
ggplot(aes(x= EstimatedReturn, y = BorrowerAPR),
       data = subset(loan2,!is.na(EstimatedReturn)))+
    xlim(0,quantile(
        subset(loan2,!is.na(EstimatedReturn))$EstimatedReturn, 0.99))+
  geom_point(color = '#F79420',alpha = 1/20)+
  geom_smooth(method = 'lm')
```

We can find the borrower APR increase when Estimated return increase.

Then we will analyze the Prosper Score with Borrower APR

```{r ProsperScore and BorrowerAPR}
ggplot(data = subset(loan2,!is.na(ProsperScore)), 
       aes(x= ProsperScore, y = BorrowerAPR))+
    xlim(0,quantile(subset(loan2,!is.na(ProsperScore))$ProsperScore, 0.99))+
    geom_jitter(color = '#F79420',alpha =1/40)+
    geom_smooth(method = 'lm')
```

We can find the borrower APR decrease when Prosper Score increase.

Then we will analyze the Credit Score with Borrower APR

```{r BorrowerAPR and CreditScoreRangeLower}
ggplot(data = subset(loan2,!is.na(BorrowerAPR)&!is.na(CreditScoreRangeLower)), 
       aes(x= BorrowerAPR, y = CreditScoreRangeLower) )+
    xlim(0.05,0.4)+
    ylim(400,900)+
    geom_jitter(color = '#F79420', alpha = 1/20)+
    geom_smooth(method = 'lm')
```

We can find the credit score decrease when the borrower APR increase.

# Then we analyze those factors effect
From the analysis above, we can find the key parameters are the borrower APR and the loan original amount, with whom other parameters have relation.

Then I would analyze other factors relation with them. 

To simplify the analysis, I would use practical experience to reallocate those factors:

For loan status, we can set 4 case:
In process contains current and Final payment in process; Past Due contains all Past Due; completed; Bad debt contains defaulted and chargedoff. However, since "completed" could used to be any other case, I would only analyze on the other.

```{r status}
status <- loan2$LoanStatus
levels(status) <- c(NA, "Bad debt", NA,"In process","Bad debt",
                    "In process","Past Due","Past Due","Past Due",
                    "Past Due","Past Due","Past Due")
loan2$status <-status
```

For Loan Origination year, we can split it as pre 2009 and post 2009, due to the financial crisis.

```{r years}
year <- factor(loan2$LoanOriginationyear)
levels(year) <- c("Pre-2009","Pre-2009","Pre-2009","Pre-2009","Pre-2009", 
                  "Post-2009","Post-2009","Post-2009","Post-2009","Post-2009")
loan2$year <-year

```
Now make a pair comparement bewteen Loan original amount v.s. other factors

```{r LoanOriginalAmount vs factors,cache=TRUE, cache.path="cache/", fig.path="fig/",fig.height=10,fig.width=10}
set.seed(1)
loan_sample = loan2[sample(1:length(loan2$LoanOriginalAmount), 10000),
                    c("LoanOriginalAmount","status",
                      "ProsperRating..Alpha.","year")]

ggpairs(data=loan_sample)
```

we can find all factors above affected OriginalAmount.

First we analyze the loan origianl amount and loan status


```{r LoanOriginalAmount and Loan  status}
loan_sample = loan2[ c("LoanOriginalAmount","status")]
loan_sample$loan_status <- factor(loan_sample$status, 
                                  c("In process", "Past Due","Bad debt"))
loan_sample=subset(loan_sample,!is.na(loan_status))
ggplot(loan_sample, 
       aes(x = LoanOriginalAmount,y=..count..,
           colour=loan_status,fill=loan_status))+
    geom_density(position = "fill")+
    geom_abline(slope=-1.5e-5,intercept = 0.45,color="white")
```

We can easily find there is a magin between different status. Most bad debt occupy more percentage at lower loan original amount,and the past due and in process debts occupy more percentage at higher loan original amount. It shows that if you have a higher loan original amount, you are more likely to pay the debt.

Next we analyze the stat summary of the data:

```{r LoanOriginalAmount and Loan  status barplot}
ggplot(loan_sample, 
       aes(x = loan_status,
           y=LoanOriginalAmount))+
    geom_boxplot(aes(fill = loan_status)) +
    guides(fill = guide_legend(title = "Loan status"))+
    stat_summary(fun.data = "mean_cl_boot", colour = "white", size = 1)
```

We can easily find bad debt had lower mean and median loan original amount compared to past due and in process.

I would analyze the diffence after Adding the occupation:

```{r status occupation average income preprocess combine Plot}
sub_data <- subset(loan2, !is.na(status)&!is.na(Occupation)&Occupation!="") %>%
    group_by(status,Occupation) %>%
    summarise(avgincome = sum(StatedMonthlyIncome)/n(),n=n())
sub_data2 <- subset(loan2, !is.na(status)&!is.na(Occupation)&Occupation!="")%>%
    group_by(Occupation) %>%
    summarise(total=n())

Total <- merge(sub_data, sub_data2, by="Occupation")%>%
    mutate(Percent=n/total)

Total$status <- factor(Total$status, c("Bad debt","In process"))
Total <- subset(Total,!is.na(status))
a <- quantile(Total$Percent, 0.8)
a <- Total[,"Percent"]>1


ggplot() + 
  facet_wrap(~status)+
  geom_point(aes(x = avgincome, y = Percent,color=status),
             data = subset(Total,status!="Past Due"),alpha = 0.5, 
             size = 1, position = 'jitter') +
  scale_color_brewer(palette = "Set1",type = 'div',
    guide = guide_legend(title = 'status', reverse = T,
    override.aes = list(alpha = 1, size = 2))) +  
    geom_smooth(aes(x = avgincome, y = Percent,color=status),
                data = subset(Total,status!="Past Due"),
                method = "lm",formula = y~log(x))+
    xlab('Average Income USD')+
    scale_x_log10()+
    ggtitle('Trend of different Loan status', subtitle = NULL)+
    theme(plot.title = element_text(hjust = 0.5))

    
```

We can find the linear model fit well for both status. I would analyze in the Final plot 2 for details.

From here, we might also interested in why those have highest average income and least bad debt occupation would like to debt.


```{r Plot_3}
limit <- c("Student - Technical School","Student - College Junior",
           "Student - Community College","Student - College Sophomore",
           "Student - College Freshman")
sub_data <- subset(loan2,Occupation %in% limit&
                       ListingCategory!="Not Available"&
                       ListingCategory!="Other"&
                       ListingCategory!="Debt Consolidation")
sub_data1 <- sub_data %>%
    group_by(Occupation,ListingCategory)%>%
    summarise(n=n())%>%
    arrange(Occupation,desc(n))%>%
    slice(1:5)
sub_data2 <- sub_data %>%
    group_by(Occupation)%>%
    summarise(count=n())

Total1 <- merge(sub_data1,sub_data2, by="Occupation") %>%
    mutate(Percent= n/count)


limit <- c("Judge","Dentist","Attorney","Psychologist",
           "Pilot - Private/Commercial")
sub_data <- subset(loan2,
                   Occupation %in% limit&ListingCategory!="Not Available"&
                       ListingCategory!="Other"&
                       ListingCategory!="Debt Consolidation")
sub_data1 <- sub_data %>%
    group_by(Occupation,ListingCategory)%>%
    summarise(n=n())%>%
    arrange(Occupation,desc(n))%>%
    slice(1:5)
sub_data2 <- sub_data %>%
    group_by(Occupation)%>%
    summarise(count=n())

Total2 <- merge(sub_data1,sub_data2, by="Occupation")%>%
    mutate(Percent= n/count)
ggplot(data=Total2, aes(x = ListingCategory,y = Occupation, fill = Percent)) +
  geom_tile() +
    ggtitle('Debt reasons of top 5 least bad debt occupations')+
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.text.x=element_text(angle = 90))+
  scale_fill_gradientn(colours = colorRampPalette(c("lightblue",
                                                    "darkblue"))(100))

```

I would give a detail analysis in the Final plot 3.

Next I will analyze the original amount and prosper rating

```{r LoanOriginalAmount and Prosper rating part1}
loan_sample = loan2[, c("LoanOriginalAmount","ProsperRating..Alpha.")]
loan_sample$ProsperRating <- factor(loan_sample$ProsperRating..Alpha., 
                                    c("AA", "A", "B","C","D","E","HR",NA))

ggplot(data=subset(loan_sample,!is.na(ProsperRating)), 
       aes(x = LoanOriginalAmount,y=..density..,
           colour=ProsperRating,fill=ProsperRating))+
    geom_density(position = "fill")
```

Since AA data peak at 15000, the others have a trend with the loan original amount, we would exclude that to analyze again

```{r LoanOriginalAmount and Prosper rating part2}
loan_sample$ProsperRating <- factor(loan_sample$ProsperRating..Alpha., 
                                    c(NA, "A", "B","C","D","E","HR",NA))

ggplot(data=subset(loan_sample,!is.na(ProsperRating)), 
       aes(x = LoanOriginalAmount,y=..count..,
           colour=ProsperRating,fill=ProsperRating))+
    geom_density(position = "fill")+
    geom_abline(slope = -1e-5,intercept = 0.85,color="white")+
    geom_abline(slope = -2e-5,intercept = 0.7,color="white")+
    geom_abline(slope = -3e-5,intercept = 0.55,color="white")+
    geom_abline(slope = -4e-5,intercept = 0.25,color="white")

```

We can find there are margins between different prosper rating. The higher rate debt occupy more percentage of higher loan origianl amount, the lower rate occupy more percentage of lower loan original amount. 
It shows that the higher your rate at Prosper, the higher amount you could borrow at Prosper.
We can also find the AA rating is not depend on how much you borrow.

Next, I would analyze the stat summary of the data:

```{r LoanOriginalAmount and Prosper rating barplot}
ggplot(data=subset(loan_sample,!is.na(ProsperRating)), 
       aes(x = ProsperRating ,y=LoanOriginalAmount))+
    geom_boxplot(aes(fill = ProsperRating)) +
    coord_flip()+
    guides(fill = guide_legend(title = "ProsperRating"))+
    stat_summary(fun.data = "mean_cl_boot", colour = "white", size = 1)
```

We can hardly find any difference of the mean and median of loan original amount among prosper rating B, A and AA, or between HR and E. However, as the Rate increase, the mean and median loan original amount increase.

Then I would analyze loan original amount with loan original year.

```{r LoanOriginalAmount and year}
ggplot(data=subset(loan2,!is.na(year)), 
       aes(x = LoanOriginalAmount,y=..density..,colour=year,fill=year))+
    geom_density(position = "fill")+
    geom_abline(slope=2.5e-5,intercept = 0.25,color="white")
```

We can find there is a magin between pre-2009 and post-2009. Most pre-2009 debt occupy more percentage at lower loan original amount,and post-2009 debts occupy more percentage at higher loan original amount. It shows that borrowers debt more at Prosper after 2009.

Next, I would analyze the stat summary of the data:

```{r LoanOriginalAmount and year barplot}
   
ggplot(data=subset(loan2,!is.na(year)), 
       aes(x = year,
           y= LoanOriginalAmount))+
    geom_boxplot(aes(fill = year)) +
    guides(fill = guide_legend(title = "Year"))+
    stat_summary(fun.data = "mean_cl_boot", colour = "white", size = 1)
```

We can find Pre-2009 had lower mean and median of loan original amount compared to Post-2009.


Since we have already analyze the relationship between BorrowerAPR and Prosper Rating before, we know focus on other two factors.

```{r BorrowerAPR vs factors, cache=TRUE, cache.path="cache/", fig.path="fig/",fig.height=10,fig.width=10}
set.seed(1)
loan_sample = loan2[sample(1:length(loan2$LoanOriginalAmount), 10000),
                    c("BorrowerAPR","status","year")]
names(loan_sample)
ggpairs(data=loan_sample)
```

we can find all factors above affect BorrowerAPR.

```{r BorrowerAPR and Loan Status}
x = seq(0,0.4,0.001)
loan_sample$loan_status <- factor(loan_sample$status, 
                                  c("In process", "Past Due","Bad debt"))

ggplot()+
    geom_density(data=subset(loan_sample,!is.na(loan_status)), 
                 aes(x =BorrowerAPR,y=..count..,colour=loan_status,
                     fill=loan_status),position = "fill")+
    geom_point(aes(x=seq(0,0.4,0.001), y=1 + 25*x*(x-0.4)),
               color="white",size=1e-4)
```

We can easily find there are quadratic relationship between borrower APR and loan status In process and past due.
The Borrowewr APR closer to 0.2 will have more percentage of In process debt and past due, the Borrowewr APR closer to 0 or 0.4 will have more percentage of bad debt.

Next, I would analyze the stat summary of the data:

```{r BorrowerAPR and Loan Status barplot}
 
                ggplot(data=subset(loan_sample,!is.na(loan_status)), 
       aes(x = loan_status,
           y= BorrowerAPR))+
    geom_boxplot(aes(fill = loan_status)) +
    guides(fill = guide_legend(title = "loan_status"))+
    stat_summary(fun.data = "mean_cl_boot", colour = "white", size = 1)
```

We can find In process had lower mean and median of BorrowerAPR compared to Past Due and Bad debt.


Then we will analyze borrowerAPR and loan original year.

```{r BorrowerAPR and Loan original year barplot}
x = seq(0,0.5,0.001)
ggplot()+
    geom_density(data=subset(loan2,!is.na(year)), 
                 aes(x = BorrowerAPR,y=..density..,colour=year,fill=year), 
                 position = "fill")+
    geom_point(aes(x=seq(0,0.5,0.001), y=0 - 9*x*(x-0.5)),
               color="white",size=1e-4)
```

We can easily find there are quadratic relationship between borrower APR and post-2009 debt. The Borrowewr APR closer to 0.25 will have more percentage of post-2009 debt, the Borrowewr APR closer to 0 or 0.5 will have more percentage of pre-2009 debt.

Next, I would analyze the stat summary of the data:

```{r BorrowerAPR and year barplot}
ggplot(data=subset(loan_sample,!is.na(year)), 
       aes(x = year,
           y= BorrowerAPR))+
    geom_boxplot(aes(fill = year)) +
    guides(fill = guide_legend(title = "year"))+
    stat_summary(fun.data = "mean_cl_boot", colour = "white", size = 1)
```

We can find Pre-2009 had lower mean and median of BorrowerAPR compared to Post-2009.

After all the pair comparement, we can also find how much average income each state has

```{r borrower average income state map}
all_states <- map_data("state")
borrowerstate <- loan2 %>%
    group_by(BorrowerState) %>%
    summarise(avg_income = mean(StatedMonthlyIncome)) %>%
arrange(BorrowerState)

borrowerstate <- borrowerstate[borrowerstate$BorrowerState!="",]

borrowerstate$region <-stateFromLower(borrowerstate$BorrowerState)

Total <- merge(all_states, borrowerstate, by="region")

ggplot()+ 
    geom_polygon(data=Total, aes(x=long, y=lat, group = group,
                                 fill=Total$avg_income),colour="white") + 
    scale_fill_continuous(low = "white", high = "darkgreen", guide="colorbar")+ 
    theme_bw()  + 
    labs(fill = "borrowers",
         title = "Average Income of borrowers in each state", x="", y="")+
    scale_y_continuous(breaks=c()) + scale_x_continuous(breaks=c()) + theme(panel.border =  element_blank())

```

We can easily find most state have average monthly income lower than 6,000. The richest state locate mostly near the sea. Connecticut was the only state had a higher than 7,000 average monthly income.


```{r borrower homeowner percentage state map}
all_states <- map_data("state")
borrowerstate <- loan2 %>%
    group_by(BorrowerState) %>%
    summarise(percent_homeowner=
                  sum(as.logical(IsBorrowerHomeowner)==TRUE)/n()) %>%
    arrange(BorrowerState)

borrowerstate <- borrowerstate[borrowerstate$BorrowerState!="",]

borrowerstate$region <-stateFromLower(borrowerstate$BorrowerState)

Total <- merge(all_states, borrowerstate, by="region")

ggplot()+ 
    geom_polygon(data=Total, aes(x=long, y=lat, group = group,
                                 fill=Total$percent_homeowner),
                 colour="white") + 
    scale_fill_continuous(low = "white", high = "gold3", guide="colorbar")+ 
    theme_bw()  + 
    labs(fill = "borrowers",
         title = "Percentage of homeowners of borrowers in each state", 
         x="", y="")+
    scale_y_continuous(breaks=c()) + scale_x_continuous(breaks=c()) +
    theme(panel.border =  element_blank())

```

We can easily find most state have average monthly income lower than 60%. The highest home onwer percentage state locate mostly far away from the sea. Wyoming was the only state had a higher than 70% home onwer. 

Next, 

```{r borrower average loan amount state map}
all_states <- map_data("state")
borrowerstate <- loan2 %>%
    group_by(BorrowerState) %>%
    summarise(avg_amount=mean(LoanOriginalAmount)) %>%
    arrange(BorrowerState)

borrowerstate <- borrowerstate[borrowerstate$BorrowerState!="",]

borrowerstate$region <-stateFromLower(borrowerstate$BorrowerState)

Total <- merge(all_states, borrowerstate, by="region")

ggplot()+ 
    geom_polygon(data=Total, 
                 aes(x=long, y=lat, group = group, fill=Total$avg_amount),
                 colour="white") + 
    scale_fill_continuous(low = "white", high = "red", guide="colorbar")+ 
    theme_bw()  + 
    labs(fill = "borrowers",
         title = "Borrowers' average loan amount in each state", x="", y="")+
    scale_y_continuous(breaks=c()) + scale_x_continuous(breaks=c()) +
    theme(panel.border =  element_blank())
```

We can easily find most state have average loan amount higher than 7,000. district of columbia was the only state had a higher than 10,000 average loan amount.

# Bivariate Analysis
### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?
When loan original amount increased, the monthly loan payment would increase, borrowerAPR would also increase. When loan original amount was lower, there would be more bad debt, lower prosper rating, and more pre-2009 debt.
When borrowerAPR increased, the estimated return would increase, the prosper score would decrease, and the credit score would decrease. When the borrowerAPR is close the 0.25, there would be more debt in process, more post-2009 debt.

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?
The state map with average income and percentage of homeowners of borrowers 
was the most interesting. If the state is on the coast, its borrowers would have higher average income but lower percentage of homeowners. If the state if far away from sea, its borrowers would have lower average income but higher percentage of homeowners.

### What was the strongest relationship you found?
The relationship between monthly payment and original total amount, its corelation is 0.93.


# Multivariate Plots Section
First, I would analyze the relationshiop between loan original amount, monthly loan payment and loan status.
Since I had analyzed the relationship between Loan Original Amount and Monthly Loan Payment, here I would check whether add the loan status make any difference.
To campare different models, we can use AIC to evaluate the performance of different Model. The better model would had a lower AIC

```{r LoanOriginalAmount MonthlyLoanPayment and LoanStatus classification}
loan_sample = loan2[, c("LoanOriginalAmount","MonthlyLoanPayment","status")]
loan_sample$Team2 <- factor(loan_sample$status, 
                            c("In process", "Past Due","Bad debt"))
loan_sample = subset(loan_sample,!is.na(status)&MonthlyLoanPayment>0)
fit <- glm(MonthlyLoanPayment~LoanOriginalAmount+Team2,data =loan_sample )
fit2 <- glm(MonthlyLoanPayment~LoanOriginalAmount,data =loan_sample )
```

Model only consider LoanOriginalAmount and MonthlyLoanPayment, have AIC:

```{r}
fit2$aic
```

New Model also consider LoanStatus, have AIC:

```{r}
fit$aic
```

We can find the new model's aic is lower than original, which means add loan status make more sense in analysis. Next, I would plot the new graph to show the difference.

```{r LoanOriginalAmount,MonthlyLoanPayment and LoanStatus,warning=FALSE}
ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment, colour = Team2), data = loan_sample) + 
  geom_point(alpha = 0.5, size = 1, position = 'jitter') +
  scale_color_brewer(type = 'div',
    guide = guide_legend(title = 'Loan Status', reverse = T,
    override.aes = list(alpha = 1, size = 2))) +  
    xlim(0,20000)+
    ylim(0,700)+
  ggtitle('')+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1], color="brown")+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[4],
                color="darkgreen")
```

The current and Finalpayment in process is in the lower region, the Past Due and Bad debt is in the upper region. 

Then, I would analyze the relationshiop between loan original amount, monthly loan payment and ProsperRating.
Since I had analyzed the relationship between Loan Original Amount and Monthly Loan Payment, here I would check whether add the ProsperRating make any difference 

```{r LoanOriginalAmount,MonthlyLoanPayment and ProsperRating classification}
loan_sample = loan2[, c("LoanOriginalAmount",
                      "MonthlyLoanPayment",
                      "ProsperRating..Alpha.")]
loan_sample$Team2 <- factor(loan_sample$ProsperRating..Alpha., 
                            c("AA", "A", "B","C","D","E","HR",""))
loan_sample = subset(loan_sample,!is.na(Team2)&Team2!=""&MonthlyLoanPayment>0)
fit <- glm(MonthlyLoanPayment~LoanOriginalAmount+Team2,data =loan_sample )
fit2 <- glm(MonthlyLoanPayment~LoanOriginalAmount,data =loan_sample )
```

Model only consider LoanOriginalAmount and MonthlyLoanPayment, have AIC:

```{r}
fit2$aic
```

New Model also consider Prosper rating, have AIC:

```{r}
fit$aic
```

We can find the new model's aic is lower than original, which means add ProsperRating make more sense in analysis. 

Next, I would plot the new graph to show the difference.

```{r LoanOriginalAmount,MonthlyLoanPayment and ProsperRating,warning=FALSE}
ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment, colour = Team2), 
       data = loan_sample) + 
  geom_point(alpha = 0.5, size = 1, position = 'jitter') +
  scale_color_brewer(type = 'div',
    guide = guide_legend(title = 'ProsperRating', reverse = T,
    override.aes = list(alpha = 1, size = 2))) +  
  ggtitle('')+
    xlim(0,20000)+
    ylim(0,700)+
    theme_dark()+
    geom_abline(slope=0.085,intercept = 0,color="red")+
    geom_abline(slope=0.03,intercept = 0,color="red")+
    geom_abline(slope=0.02,intercept = 0,color="red")

```

The Monthly Payment decided by loan original amount, interests rate and payment duration. The interests rate would be influenced by market, so there are 3 region in the map, indicate 3 different market rates. In each region, we can find better loan status will have a lower slope between loan orignal amount and monthly payment, which indicated a longer duration for higher loan status.
I would analyze the relationship of durantion and APR for different loan status.

```{r Plot_1}

NPER <- function(rate, pmt, pv, fv=0, type=0){
  nper = ifelse(rate!=0,
        log10((pmt*(1+rate*type)-fv*rate)/(pmt*(1+rate*type)+pv*rate))/
            log10(1+rate),
        -1*(fv+pv)/pmt)
  nper = as.integer(-nper)
  return(nper)
  }

sample_data = subset(loan2,!is.na(MonthlyLoanPayment)&!is.na(LenderYield)&
                        !is.na(LoanOriginalAmount)&!is.na(BorrowerAPR)&
                         !is.na(status))
sample_data$N <- mapply(NPER,sample_data$LenderYield,
                        sample_data$MonthlyLoanPayment,
                        sample_data$LoanOriginalAmount)
sample_data$N <- as.integer(sample_data$N)
sample_data <- subset(sample_data,!is.na(N))
Nfactor <- function(N){
    Nrank = 0
    if(N<qN[1]){Nrank = "~5"}
    else if(N<qN[2]&N>=qN[1]){Nrank = "5~9"}
    else if(N<qN[3]&N>=qN[2]){Nrank = "9~11"}
    else if(N<qN[4]&N>=qN[3]){Nrank = "11~13"}
    else if(N>=qN[4]){Nrank = "13~"}
    return(Nrank)
}
sample_data =sample_data[, c("LoanOriginalAmount","MonthlyLoanPayment",
                             "status","N","BorrowerAPR")]

qN = quantile(sample_data$N)
sample_data$Nrank <-factor(as.character( lapply(sample_data$N,Nfactor)))
sample_data$Nrank <-factor(sample_data$Nrank,
                           c("~5","5~9","9~11","11~13","13~"))

APRfactor <- function(APR){
    APRrank = 0
    if(APR<qAPR[1]){APRrank = "~0.01"}
    else if(APR<qAPR[2]&APR>=qAPR[1]){APRrank = "0.01~0.17"}
    else if(APR<qAPR[3]&APR>=qAPR[2]){APRrank = "0.17~0.21"}
    else if(APR<qAPR[4]&APR>=qAPR[3]){APRrank = "0.21~0.28"}
    else if(APR>=qAPR[4]){APRrank = "0.28~"}
    return(APRrank)
}
qAPR = quantile(sample_data$BorrowerAPR)

sample_data$APRrank <-factor(as.character(
    lapply(sample_data$BorrowerAPR,APRfactor)))

sub_data <- sample_data %>%
    group_by(Nrank,APRrank,status) %>%
    summarise(Count = n())

sub_data2 <- sample_data %>%
    group_by(status) %>%
    summarise(status_count = n())

Total <- merge(sub_data, sub_data2, by="status")

Total <- Total %>%
    mutate(Percent=Count/status_count)
    
Total$status <- factor(Total$status, c("In process", "Past Due","Bad debt"))

ggplot(aes(y = Nrank, x = APRrank, fill = Percent),
  data = Total) +
  geom_tile() +
  scale_fill_gradientn(colours = colorRampPalette(c("lightyellow", "blue"))(100))+
    facet_wrap(~status)+
    ggtitle('Relationship between Loan duration, APR and Prosper rating', subtitle = NULL)+
    theme(plot.title = element_text(hjust = 0.5))
```

We can find the loan status are different for different APR and N (Duration).
I would give the detail of analysis in the Final plot 1.

Then, I would analyze the relationshiop between loan original amount, monthly loan payment and Loan Orination year.
Since I had analyzed the relationship between Loan Original Amount and Monthly Loan Payment, here I would check whether add the Loan Orination year make any difference 

```{r LoanOriginalAmount,MonthlyLoanPayment and Loan Orination year classification}
loan_sample = loan2[, c("LoanOriginalAmount","MonthlyLoanPayment","year")]
loan_sample = subset(loan_sample,!is.na(year)&MonthlyLoanPayment>0)
fit <- glm(MonthlyLoanPayment~LoanOriginalAmount+year,data =loan_sample )
fit2 <- glm(MonthlyLoanPayment~LoanOriginalAmount,data =loan_sample )
```

Model only consider LoanOriginalAmount and MonthlyLoanPayment, have AIC:

```{r}
fit2$aic
```

New Model also consider Loan original year, have AIC:

```{r}
fit$aic
```

We can find the new model's aic is lower than original, which means add loan original year make more sense in analysis. However, the difference between two models is limited. Next, I would plot the new graph to show the difference.

```{r LoanOriginalAmount,MonthlyLoanPayment and Loan Orination year}
ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment, colour = year), 
       data = subset(loan_sample,!is.na(year)&MonthlyLoanPayment>0)) + 
  geom_point(alpha = 0.5, size = 1, position = 'jitter') +
  scale_color_brewer(palette = "Set1",type = 'div',
    guide = guide_legend(title = 'year', reverse = T,
    override.aes = list(alpha = 1, size = 2))) +  
  ggtitle('')+
    xlim(0,20000)+
    ylim(0,700)+
    geom_abline(slope=fit$coefficients[2],
                intercept = fit$coefficients[1], 
                colour="darkred")+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[3], 
                color="darkblue")
```

The post-2009 is in the lower region, the pre-2009 is in the upper region. 
However, the difference is small and two line were close.

Then, I would analyze the relationshiop between BorrowerAPR, CreditScoreRangeLower and LoanStatus.
Since I had analyzed the relationship between BorrowerAPR and CreditScoreRangeLower before, here I would check whether add the Loan Status make any difference 

```{r BorrowerAPR, CreditScoreRangeLower and LoanStatus classification}
loan_sample = loan2[, c("BorrowerAPR","CreditScoreRangeLower","status")]
loan_sample$Team2 <- factor(loan_sample$status, 
                            c("In process", "Past Due","Bad debt"))

loan_sample = subset(loan_sample,!is.na(Team2)&CreditScoreRangeLower>400)

fit <- glm(CreditScoreRangeLower~BorrowerAPR+Team2,data =loan_sample )
fit2 <- glm(CreditScoreRangeLower~BorrowerAPR,data =loan_sample )
```

Model only consider BorrowerAPR and CreditScoreRangeLower, have AIC:

```{r}
fit2$aic
```

New Model also consider LoanStatus, have AIC:

```{r}
fit$aic
```

We can find the new model's aic is lower than original, which means add Loan status make more sense in analysis.  Next, I would plot the new graph to show the difference.

```{r BorrowerAPR, CreditScoreRangeLower and LoanStatus,warning=FALSE}
ggplot(aes(x= BorrowerAPR, y = CreditScoreRangeLower, colour = Team2), 
       data =loan_sample) + 
  geom_point(alpha = 0.5, size = 1, position = 'jitter') +
  scale_color_brewer(palette = "Set1",type = 'div',
                     guide = guide_legend(title = 'Loan Status', 
                                          reverse = T,
                                          override.aes=list(alpha=1,size=2)))+  
  ggtitle('')+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1],
                color="red",col=2,lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[4],
                color="green",col=2,lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[3],
                color="blue",col=2,lty=2)
    
```

The in process and the Past Due are in the upper region,  the Bad debt is in the lower region. 

Then, I would analyze the relationshiop between BorrowerAPR, CreditScoreRangeLower and prosperscore.
Since I had analyzed the relationship between BorrowerAPR and CreditScoreRangeLower before, here I would check whether add the prosperscore make any difference

```{r BorrowerAPR, CreditScoreRangeLower and Prosperscore Ranking, classfication}
loan_sample = loan2[, c("BorrowerAPR",
                        "CreditScoreRangeLower",
                        "ProsperRating..Alpha.")]
loan_sample$Team2 <- factor(loan_sample$ProsperRating..Alpha., 
                            c("AA", "A", "B","C","D","E","HR",""))
loan_sample = subset(loan_sample,Team2!=""&CreditScoreRangeLower>400)
fit <- glm(BorrowerAPR~CreditScoreRangeLower+Team2,data =loan_sample )
fit2 <- glm(BorrowerAPR~CreditScoreRangeLower,data =loan_sample )
```

Model only consider BorrowerAPR and CreditScoreRangeLower, have AIC:

```{r}
fit2$aic
```

New Model also consider Prosper Rating, have AIC:

```{r}
fit$aic
```

We can find the new model's aic is much lower than original, which means add Prosperscore Ranking make more sense in analysis.  Next, I would plot the new graph to show the difference.

```{r BorrowerAPR, CreditScoreRangeLower and Prosperscore Ranking,warning=FALSE}
ggplot(aes(x = CreditScoreRangeLower, y = BorrowerAPR, colour = Team2), 
       data = loan_sample) + 
  geom_point(alpha = 0.5, size = 1, position = 'jitter') +
  scale_color_brewer(type = 'div',
    guide = guide_legend(title = 'ProsperRating', reverse = T,
    override.aes = list(alpha = 1, size = 2))) +  
    theme_dark()+
  ggtitle('')+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1], 
                col="white",lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[3],
                col="white",lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[4],
                col="white",lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[5],
                col="white",lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[6],
                col="white",lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[7],
                col="white",lty=2)+
    geom_abline(slope=fit$coefficients[2], 
                intercept = fit$coefficients[1]+fit$coefficients[8],
                col="white",lty=2)
```

we can find better loan status will have a lower borrowerAPR at same credit score.

Then, I would analyze the relationshiop between BorrowerAPR, CreditScoreRangeLower and prosperscore.
Since I had analyzed the relationship between BorrowerAPR and CreditScoreRangeLower before, here I would check whether add the rosperscore and prosperscore make any difference.

```{r BorrowerAPR,CreditScoreRangeLower, LoanStatus and Prosperscore Ranking}
loan_sample = loan2[, 
                    c("BorrowerAPR","CreditScoreRangeLower",
                      "status","ProsperRating..Alpha.")]
loan_sample$Team2 <- factor(loan_sample$status, 
                            c("In process", "Past Due","Bad debt"))
loan_sample$Team3 <- factor(loan_sample$ProsperRating..Alpha., 
                            c("AA", "A", "B","C","D","E","HR",""))

ggplot(aes(x = BorrowerAPR, y = CreditScoreRangeLower, colour = Team3), 
       data = subset(loan_sample,
                     Team2!=""&Team3!=""&!is.na(Team3)&CreditScoreRangeLower>0))+
  facet_wrap( ~Team2)+
  geom_point(alpha = 0.5, size = 1, position = 'jitter') +
  scale_color_brewer(palette = "Set1",
                     type = 'div',
                     guide = guide_legend(
                         title = 'ProsperRating', reverse = T,
                         override.aes = list(alpha = 1, size = 2))) +
    ggtitle('')

```

We can find from in process to bad debt, the average prosper rating get lower, the borrowerAPR get higher and credit score get lower.



# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?
Loan status and Prosper rating differentiated the relationship between monthly payment and loan original amount and the relationship between credit score and borrower APR.
Loan status and prosper rating strendthened each other at borrowerAPR from the last graph, since higher borrowerAPR indicated less likedly to pay back, where bad debt percentage is higher; For those who were more likely to have a bad debt, they would more likely to have a lower prosper rating.

### Were there any interesting or surprising interactions between features?
The most interesting interaction is the propsperrating with borrowerAPR and credit score, we can find there are different layers for different prosper raing.
The most surprising interaction is the loan original year with loan original amount and monthly payment. It seems a common sense that there should be a different between post-2009 and pre-2009, however, there were not such a big difference.

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.
I have create general linear model to help me whether some of the factors could classify the data, and it shows that is true.
The strength of model is that it can be calculated and proved, the weakness is that it is not straight forward as graph.

# Final Plots and Summary
### Plot One

```{r Plot_One preprocess,warning=FALSE}

NPER <- function(rate, pmt, pv, fv=0, type=0){
  nper = ifelse(rate!=0,
        log10((pmt*(1+rate*type)-fv*rate)/(pmt*(1+rate*type)+pv*rate))/
            log10(1+rate),
        -1*(fv+pv)/pmt)
  nper = as.integer(-nper)
  return(nper)
  }

sample_data = subset(loan2,!is.na(MonthlyLoanPayment)&!is.na(LenderYield)&
                        !is.na(LoanOriginalAmount)&!is.na(BorrowerAPR)&
                         !is.na(status))
sample_data$N <- mapply(NPER,sample_data$LenderYield,
                        sample_data$MonthlyLoanPayment,
                        sample_data$LoanOriginalAmount)
sample_data$N <- as.integer(sample_data$N)
sample_data <- subset(sample_data,!is.na(N))
Nfactor <- function(N){
    Nrank = 0
    if(N<qN[1]){Nrank = "~5"}
    else if(N<qN[2]&N>=qN[1]){Nrank = "5~9"}
    else if(N<qN[3]&N>=qN[2]){Nrank = "9~11"}
    else if(N<qN[4]&N>=qN[3]){Nrank = "11~13"}
    else if(N>=qN[4]){Nrank = "13~"}
    return(Nrank)
}
sample_data =sample_data[, c("LoanOriginalAmount","MonthlyLoanPayment",
                             "status","N","BorrowerAPR")]

qN = quantile(sample_data$N)
sample_data$Nrank <-factor(as.character( lapply(sample_data$N,Nfactor)))
sample_data$Nrank <-factor(sample_data$Nrank,
                           c("~5","5~9","9~11","11~13","13~"))

APRfactor <- function(APR){
    APRrank = 0
    if(APR<qAPR[1]){APRrank = "~0.01"}
    else if(APR<qAPR[2]&APR>=qAPR[1]){APRrank = "0.01~0.17"}
    else if(APR<qAPR[3]&APR>=qAPR[2]){APRrank = "0.17~0.21"}
    else if(APR<qAPR[4]&APR>=qAPR[3]){APRrank = "0.21~0.28"}
    else if(APR>=qAPR[4]){APRrank = "0.28~"}
    return(APRrank)
}
qAPR = quantile(sample_data$BorrowerAPR)

sample_data$APRrank <-factor(as.character(
    lapply(sample_data$BorrowerAPR,APRfactor)))

```

```{r BorrwerAPR and Duration Heat Map,fig.width=10}
sub_data <- sample_data %>%
    group_by(Nrank,APRrank,status) %>%
    summarise(Count = n())

sub_data2 <- sample_data %>%
    group_by(status) %>%
    summarise(status_count = n())

Total <- merge(sub_data, sub_data2, by="status")

Total <- Total %>%
    mutate(Percent=Count/status_count)
    
Total$status <- factor(Total$status, c("In process", "Past Due","Bad debt"))

ggplot(aes(y = Nrank, x = APRrank, fill = Percent),
  data = Total) +
  geom_tile() +
  scale_fill_gradientn(colours = colorRampPalette(c("lightyellow", "blue"))(100))+
    facet_wrap(~status)+
    ggtitle('Relationship between Loan duration, APR and Prosper rating', subtitle = NULL)+
    theme(plot.title = element_text(hjust = 0.5))
```


### Description One

The first graph wants to dig in Prosper raing, loan duration and BorrwerAPR.
In the preview graph, we analyze the monthly payment and loan origianl amount. However, since there might be difference of interests rate, the slope cannot figure out the difference between prosper rating. In this case, I calculate the duration "N" by the loan original amount, monthly payment and interest rate. Each number in n suggest the longth of year for debt payment.  Then I facet the "N" to "Nrank". Combined Nrank and APRrank, we can easily figure out the difference between debt In process with others. Most of the in process debt has the least APR and the longest duration. Most of the past due and bad debt has the highest APR and the shortest duration.


### Plot Two

```{r status occupation average income preprocess Plot_Two}
sub_data <- subset(loan2, !is.na(status)&!is.na(Occupation)&Occupation!="") %>%
    group_by(status,Occupation) %>%
    summarise(avgincome = sum(StatedMonthlyIncome)/n(),n=n())
sub_data2 <- subset(loan2, !is.na(status)&!is.na(Occupation)&Occupation!="")%>%
    group_by(Occupation) %>%
    summarise(total=n())

Total <- merge(sub_data, sub_data2, by="Occupation")%>%
    mutate(Percent=n/total)

Total$status <- factor(Total$status, c("Bad debt","In process"))
Total <- subset(Total,!is.na(status))
a <- quantile(Total$Percent, 0.8)
a <- Total[,"Percent"]>1
```

```{r status occupation average income Plot_Two}
dollar_format <- function (forma){
    function(x) paste0("USD",format(x,forma))
}

ggplot() + 
  facet_wrap(~status)+
  geom_point(aes(x = avgincome, y = Percent,color=status),
             data = subset(Total,status!="Past Due"),alpha = 0.5, 
             size = 1, position = 'jitter') +
  scale_color_brewer(palette = "Set1",type = 'div',
    guide = guide_legend(title = 'status', reverse = T,
    override.aes = list(alpha = 1, size = 2))) +  
    geom_smooth(aes(x = avgincome, y = Percent,color=status),
                data = subset(Total,status!="Past Due"),
                method = "lm",formula = y~log(x))+
    scale_y_continuous(labels=percent)+
    xlab('Average Income')+
    scale_x_log10(labels = dollar_format(forma = x))+
    ggtitle('Trend of different Loan status', subtitle = NULL)+
    theme(plot.title = element_text(hjust = 0.5))


    
```

### Description Two
In order to find out who were more likely pay the debt with average income and occupation, I plot the secend graph. After rescale the average income axis, we can find the average income and percentage of debt status is simplr linear regression. The higher your average income, the higher percent you may pay back debt, the lower percent you may have bad debt. The top 5 least bad debt occupations are Judge, Dentist, Psycologies, Pilot and Attorney. The top 5 most bad debt occupations are all student of college. 

### Plot Three

```{r Plot_Three}
limit <- c("Student - Technical School","Student - College Junior",
           "Student - Community College","Student - College Sophomore",
           "Student - College Freshman")
sub_data <- subset(loan2,Occupation %in% limit&
                       ListingCategory!="Not Available"&
                       ListingCategory!="Other"&
                       ListingCategory!="Debt Consolidation")
sub_data1 <- sub_data %>%
    group_by(Occupation,ListingCategory)%>%
    summarise(n=n())%>%
    arrange(Occupation,desc(n))%>%
    slice(1:5)
sub_data2 <- sub_data %>%
    group_by(Occupation)%>%
    summarise(count=n())

Total1 <- merge(sub_data1,sub_data2, by="Occupation") %>%
    mutate(Percent= n/count)


limit <- c("Judge","Dentist","Attorney","Psychologist",
           "Pilot - Private/Commercial")
sub_data <- subset(loan2,
                   Occupation %in% limit&ListingCategory!="Not Available"&
                       ListingCategory!="Other"&
                       ListingCategory!="Debt Consolidation")
sub_data1 <- sub_data %>%
    group_by(Occupation,ListingCategory)%>%
    summarise(n=n())%>%
    arrange(Occupation,desc(n))%>%
    slice(1:5)
sub_data2 <- sub_data %>%
    group_by(Occupation)%>%
    summarise(count=n())

Total2 <- merge(sub_data1,sub_data2, by="Occupation")%>%
    mutate(Percent= n/count)

```

```{r plot3}
ggplot(data=Total2, aes(x = ListingCategory,y = Occupation, fill = Percent)) +
  geom_tile() +
    ggtitle('Debt reasons of top 5 least bad debt occupations')+
    theme(plot.title = element_text(hjust = 0.5))+
    theme(axis.text.x=element_text(angle = 90))+
  scale_fill_gradientn(colours = colorRampPalette(c("lightblue",
                                                    "darkblue"))(100))

```

### Description Three
The last graph wants to show why the top 5 least bad debt occupations wants to debt.
Since we did not know what is the exactly reason people borrow money in "other"", "not Available"" or "debt consolidation", we would remove that from the table, even though that occupy over 50 percent of debt.
For top 5 least bad debt occupations, we can find their payment mostly on business and home improvement.

------

# Reflection

The Prosper loand dataset contains 81 variables for over 110,000 lines data. I started from two sides, one descibe the information about loan, another about borrowers, and picked 20 variables. I explord their distribution and find those interesting question and lead to the core of the each sides: Loan origianl amount and Borrowers APR. I used correation and covariance to analyze the relationship between other variables and the core in Bivariate analysis section. Eventually, I use AIC to find whether add another variables would make the sense in multivariate analysis. 

During the process, I used library dplyr to clean, subset, group and summerize data, ggplot to plot data, map to plot state map or GIS information, corrplot to show the correlation coefficient, colorbrewer to show the gradient difference between different levels of data. 

There was a clear trend between the loan original amount and monthly loan payment, estimated return, prosper rating, loan original year and occupation. There was another trend between the BorrowerAPR and Prosper rating, borrowers credit range, loan status, loan original year and occupation. I struggled understanding the relationship among loan original amount, monthly loan payment and loan status, and search for the financial definition to generate a new variable called Duration, which help us easily distinguish who might have bad debt. 

Till now, the analysis focus more on data exploration without building a predict or classify model. For further analysis, I can use general linear model to combine both numeric and factors variables for prediction and classification. Prosper can benefit from the model to find who might have more bad debt, how much should they set the origianl amount for different borrowers and how much would they earned from them.

# Reference

1. How to order the (factor) variables in ggplot2
https://kohske.wordpress.com/2010/12/29/faq-how-to-order-the-factor-variables-in-ggplot2/

2. Prosper Loan Data - Variable Definitions
https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0

3. US State Maps using map_data()
https://www.r-bloggers.com/us-state-maps-using-map_data/

4. Split time series data 
http://stackoverflow.com/questions/13649019/with-r-split-time-series-data-into-time-intervals-say-an-hour-and-then-plot-t

5. Use corcolor to plot correlation
http://www.sthda.com/english/wiki/correlation-matrix-a-quick-start-guide-to-analyze-format-and-visualize-a-correlation-matrix-using-r-software

6. colors in R
http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf

# Reproducibility
```{R}
sessionInfo()
```
